// Generated by CoffeeScript 1.12.7
(function() {
  var Hs, root;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root.Hs || (root.Hs = {});

  Hs = root.Hs;

  $(function() {
    var create_shop, current_create_shop_info, current_create_shop_info_action, get_chat, user_comment_submit_one;
    console.log("winni app user");
    get_chat = function(chat_id, comment_id, type) {
      if (comment_id == null) {
        comment_id = null;
      }
      if (comment_id === null) {
        $(".me_results").append("<div class=\"comments\" data-block=\"" + chat_id + "\">\n    <div class=\"comment_log\">Loading</div>\n</div>");
      }
      return $.ajax({
        url: "/api/page/comment/load",
        type: "GET",
        dataType: "json",
        data: {
          chat_id: chat_id,
          comment_id: comment_id
        },
        success: function(data) {
          var comment, comment_id_sequence, comment_json, e, i, ref;
          console.log(data);
          if (data.info === "error") {
            console.log(data.info);
            if (data.about === "no chat's comment") {
              console.log(data.about, "No more");
              return $(".comment_log").text("No More");
            }
          } else if (data.info = "ok") {
            ref = data.comments;
            for (i = ref.length - 1; i >= 0; i += -1) {
              comment = ref[i];
              comment_id_sequence = data.comment_id + "_" + comment[0];
              comment_json = null;
              try {
                comment_json = JSON.parse(comment[4]);
              } catch (error) {
                e = error;
                comment_json = null;
              }
              if (comment_json !== null) {
                $(".comments[data-block=" + chat_id + "]").append("<div class=\"comment\" data-id=\"" + comment_id_sequence + "\">\n    <a target=\"_blank\" href=\"/home/store/app/shop/" + comment_json["block_id"] + "\">\n        <div class=\"one_shop_card\" data-id=\"" + comment_json["block_id"] + "\">\n            <div class=\"one_shop_card_headimgurl\">\n                <img src=\"" + comment_json["headimgurl"] + "\">\n            </div>\n            <div class=\"one_shop_card_entity\">" + comment_json["block_id"] + "</div>\n            <div class=\"one_shop_card_title\">" + comment_json["title"] + "</div>\n            <div class=\"one_shop_card_desc\">" + comment_json["desc"] + "</div>\n            <div class=\"one_shop_card_address\">" + comment_json["address"] + "</div>\n        </div>\n    </a>\n</div>");
              }
            }
            if (data.last_comment_id === null) {
              $(".comment_log").remove();
              return $(".comments[data-block=" + chat_id + "]").append("<div class=\"comment_log\">No More</div>");
            } else {
              $(".comment_log").remove();
              return $(".comments[data-block=" + chat_id + "]").append("<div class=\"comment_load_more\" data-type=\"" + type + "\" data-last-comment-id=\"" + data.last_comment_id + "\">Click Load More</div>");
            }
          }
        },
        error: function(data) {
          return console.log(data);
        }
      });
    };
    current_create_shop_info = {
      "title": "",
      "desc": "",
      "headimgurl": "",
      "address": ""
    };
    create_shop = function() {
      current_create_shop_info = {
        "title": "",
        "desc": "",
        "headimgurl": "",
        "address": ""
      };
      return $("body").append("<div class=\"cover_create\">\n    <div class=\"cover_create_base\">\n        <div class=\"cover_create_card\">\n            <div class=\"cover_create_card_line\">\n                <div>Shop Name</div>\n                <div><input class=\"cover_create_card_store_title\"></div>\n            </div>\n            <div class=\"cover_create_card_line\">\n                <div>Shop Description</div>\n                <div><textarea class=\"cover_create_card_store_desc\"></textarea></div>\n            </div>\n            <div class=\"cover_create_card_line\">\n                <div>Shop Address</div>\n                <div><textarea class=\"cover_create_card_store_address\"></textarea></div>\n            </div>\n            <div class=\"cover_create_card_line\">\n                <div>Shop Profile</div>\n                <div>\n                    <div class=\"cover_create_card_store_headimgurl\">\n                        <img src=\"https://www.winni.app/static/img/winni_app/shops.png\">\n                    </div>\n                    <button\n                        class=\"img_add_upload_target_now\"\n                        data-target-class=\"cover_create_card_store_headimgurl\"\n                        data-target-rule=\"replace\"\n                    >select img</button>\n                </div>\n            </div>\n            <div class=\"cover_create_card_line\">\n                <button class=\"create_shop_action\">Create</button>\n            </div>\n\n        </div>\n    </div>\n</div>");
    };
    current_create_shop_info_action = function() {
      current_create_shop_info = {
        "title": $(".cover_create_card_store_title").val(),
        "desc": $(".cover_create_card_store_desc").val(),
        "headimgurl": $(".cover_create_card_store_headimgurl").find("img").first().attr("src"),
        "address": $(".cover_create_card_store_address").val()
      };
      return $.ajax({
        url: "/api/store/app/shop/create",
        dataType: "json",
        type: "POST",
        data: current_create_shop_info,
        success: function(data) {
          var _block_id;
          console.log(data);
          if (data.info === "ok") {
            _block_id = data.block_id;
            current_create_shop_info["block_id"] = _block_id;
            current_create_shop_info["block_type"] = "shop";
            return user_comment_submit_one(USER_ID, SHOPS_ENTITY, JSON.stringify(current_create_shop_info), function() {
              return user_comment_submit_one("5d85f0ecc99c47b78bc87f382ef4ad18", "a91eccee5a0b411388cee48a3afd7b67", JSON.stringify(current_create_shop_info), function() {
                alert("create success");
                return window.location.href = "/home/store/app/shop/" + _block_id;
              });
            });
          }
        },
        error: function(data) {
          return console.log(data);
        }
      });
    };
    user_comment_submit_one = function(block_id, chat_id, content, callback) {
      if (callback == null) {
        callback = null;
      }
      return $.ajax({
        url: "/api/page/comment/submit",
        dataType: "json",
        type: "POST",
        data: {
          block_id: block_id,
          chat_id: chat_id,
          content: content,
          uuid: uuid2(6, null)
        },
        success: function(data) {
          console.log(data);
          if (callback !== null) {
            return callback();
          }
        },
        error: function(data) {
          return console.log(data);
        }
      });
    };
    $("body").on("click", ".comment_load_more", function(evt) {
      var chat_id, last_comment_id, load_type;
      load_type = $(this).attr("data-type");
      chat_id = $(this).parents(".comments").first().attr("data-block");
      last_comment_id = $(this).attr("data-last-comment-id");
      return get_chat(chat_id, last_comment_id, load_type);
    });
    $("body").on("click", ".get_shops", function(evt) {
      var chat_id;
      $(".me_results").empty();
      chat_id = $(this).attr("data-block");
      return get_chat(chat_id, null, "shops");
    });
    $("body").on("click", ".create_shop", function(evt) {
      return create_shop();
    });
    $("body").on("click", ".create_shop_action", function(evt) {
      return current_create_shop_info_action();
    });
    return $(window).on("load", function(evt) {
      var chat_id;
      $(".me_results").empty();
      chat_id = SHOPS_ENTITY;
      return get_chat(SHOPS_ENTITY, null, "shops");
    });
  });

}).call(this);
