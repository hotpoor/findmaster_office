// Generated by CoffeeScript 1.12.7
(function() {
  var Hs, root;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root.Hs || (root.Hs = {});

  Hs = root.Hs;

  $(function() {
    var check_list_action, create_action;
    console.log("dev qrcode");
    create_action = function(time, times) {
      var aim_id, num_all, num_each, subtype, title;
      if (time >= times) {
        return;
      }
      title = $(".title").val();
      subtype = $(".subtype").val();
      aim_id = $(".aim_id").val();
      num_each = parseInt($(".num_each").val());
      num_all = parseInt($(".num_all").val());
      return $.ajax({
        url: "/api/msh/create_block",
        data: {
          title: title,
          subtype: subtype,
          aim_id: aim_id,
          amount: num_all
        },
        dataType: 'json',
        type: "POST",
        success: function(data) {
          var next_block_id;
          console.log(data);
          if (data.info === "ok") {
            next_block_id = data.entity_id;
            return $.ajax({
              url: "/api/msh/create_qrcode",
              data: {
                block_id: next_block_id,
                num: num_each
              },
              dataType: 'json',
              type: "POST",
              success: function(data) {
                console.log(data);
                if (data.info === "ok") {
                  return create_action(time + 1, times);
                }
              },
              error: function(data) {
                return console.log(data);
              }
            });
          }
        },
        error: function(data) {
          return console.log(data);
        }
      });
    };
    $("body").on("click", ".create_action", function(evt) {
      var aim_id, num_all, num_each, subtype, times, title;
      title = $(".title").val();
      subtype = $(".subtype").val();
      aim_id = $(".aim_id").val();
      num_all = parseInt($(".num_all").val());
      num_each = parseInt($(".num_each").val());
      $(".times").val(parseInt(num_all / num_each));
      times = $(".times").val();
      return create_action(0, times);
    });
    check_list_action = function(check_list) {
      var i, item_id, len, results;
      results = [];
      for (i = 0, len = check_list.length; i < len; i++) {
        item_id = check_list[i];
        results.push($.ajax({
          url: "/api/data/json",
          data: {
            block_id: item_id
          },
          dataType: 'json',
          type: "GET",
          success: function(data) {
            var a, j, len1, ref, results1;
            console.log(data);
            if (data.info === "ok") {
              if ($(".qrcode_output_line[data-name=" + data.block.title + "]").length === 0) {
                $(".qrcode_output_list").append("<table class=\"qrcode_output_line\" data-name=\"" + data.block.title + "\"></table>");
              }
              ref = data.block.qrcodes;
              results1 = [];
              for (j = 0, len1 = ref.length; j < len1; j++) {
                a = ref[j];
                results1.push($(".qrcode_output_line[data-name=" + data.block.title + "]").append("<tr><td><div>https://www.qianshanghua.com/api/msh/qrcode/" + data.block_id + "/" + a + "</div></td></tr>"));
              }
              return results1;
            }
          },
          error: function(data) {
            return console.log(data);
          }
        }));
      }
      return results;
    };
    return $("body").on("click", ".check_action", function(evt) {
      var check_aim_id, check_list;
      check_aim_id = $(".check_aim_id").val();
      check_list = [];
      return $.ajax({
        url: "/api/data/json",
        data: {
          block_id: check_aim_id
        },
        dataType: 'json',
        type: "GET",
        success: function(data) {
          console.log(data);
          if (data.info === "ok") {
            check_list = data.block.qrcodepackages;
            return check_list_action(check_list);
          }
        },
        error: function(data) {
          return console.log(data);
        }
      });
    });
  });

}).call(this);
